# 🧪 快速测试指南

## ✅ 服务状态
- **后端**: ✅ 运行在 http://localhost:8000
- **前端**: ✅ 运行在 http://localhost:3000
- **API文档**: http://localhost:8000/docs

---

## 🎯 本次修复的三个问题

### 问题1：工具调用状态默认应该折叠 ✅
**测试步骤**：
1. 在聊天框输入："搜索最新AI技术趋势"
2. 观察AI思考和工具调用过程
3. **预期结果**：
   - 工具调用状态卡片默认是**折叠**状态
   - 显示 "✅ 工具调用完成"
   - 可以点击展开查看详细信息

---

### 问题2：工具调用和thinking状态不应该重复显示 ✅
**测试步骤**：
1. 在聊天框输入任何需要工具的消息
2. 观察AI思考时的显示
3. **预期结果**：
   - 顶部消息气泡显示 "🤔 AI正在思考..."
   - **不应该**出现空的工具调用卡片显示thinking
   - 只在有工具调用时才显示工具状态卡片

---

### 问题3：切换会话后原对话的回复不应该输出到新对话 ✅
**测试步骤**：
1. 在**会话A**中输入："写一篇关于AI的500字文章"
2. 等待1-2秒（AI开始思考）
3. 立即点击 "+ New Chat" 创建**会话B**
4. 在**会话B**中输入："你好"
5. 等待两个会话的响应完成
6. 切换回**会话A**查看历史

**预期结果**：
- ✅ 会话A的文章回复**只在会话A**中显示
- ✅ 会话B的"你好"回复**只在会话B**中显示
- ✅ 两个会话**完全隔离**，互不干扰
- ✅ 会话A的历史记录**完整保留**

**浏览器控制台日志**：
```
🔄 Session changed to: [新会话ID]
🛑 Aborting ongoing request due to session change
⚠️  会话已切换，忽略此响应 { request: '旧会话ID', current: '新会话ID' }
```

---

## 📋 完整测试流程

### Step 1: 测试工具调用折叠
```
1. 打开 http://localhost:3000
2. 输入："搜索Python最新版本"
3. 观察工具调用卡片是否默认折叠
4. 点击卡片，确认可以展开查看详情
```

### Step 2: 测试thinking状态单一显示
```
1. 输入："计算1+1"
2. 观察AI思考过程
3. 确认只有消息气泡显示thinking
4. 确认没有空的工具调用卡片
```

### Step 3: 测试会话隔离（重要）
```
1. 创建会话A，输入长文本请求（例如："分析AI发展趋势"）
2. 等待1秒，立即点击 "+ New Chat" 创建会话B
3. 在会话B输入："你好"
4. 等待所有响应完成
5. 检查：
   - 会话A只有"分析AI发展趋势"的回复
   - 会话B只有"你好"的回复
   - 两者互不干扰
```

### Step 4: 测试会话历史保留
```
1. 在会话A中发送多条消息
2. 切换到会话B
3. 再切换回会话A
4. 确认会话A的所有历史消息都完整保留
```

---

## 🔍 调试技巧

### 打开浏览器开发者工具
```
Chrome/Edge: F12 或 Cmd+Option+I (Mac)
Firefox: F12 或 Cmd+Option+K (Mac)
```

### 查看控制台日志
在 Console 标签中查看：
- `🔄 Session changed to:` - 会话切换日志
- `🛑 Aborting ongoing request` - 请求中断日志
- `⚠️  会话已切换，忽略此响应` - 响应过滤日志
- `📥 Response received:` - 响应接收日志

### 查看网络请求
在 Network 标签中查看：
- `/api/chat/message` - 发送消息请求
- `/api/tools/history/{session_id}` - 工具调用历史请求
- 检查请求状态、响应内容

---

## ⚠️ 已知问题排查

### 问题：前端显示"无法连接到服务器"
**解决方案**：
```bash
# 检查后端是否运行
lsof -nP -iTCP:8000 -sTCP:LISTEN

# 如果没有运行，重启后端
cd /Users/xiaochenwu/Desktop/Agent-V3
source .venv/bin/activate
python api_server.py
```

### 问题：会话切换后仍然出现消息串扰
**排查步骤**：
1. 打开浏览器控制台
2. 查找 `⚠️  会话已切换，忽略此响应` 日志
3. 如果没有此日志，说明会话ID验证未生效
4. 检查 `frontend/components/chat-interface.tsx` 是否已更新

### 问题：工具调用状态没有折叠
**排查步骤**：
1. 检查工具调用是否真的执行了（有工具调用记录）
2. 查看控制台是否有错误
3. 确认 `chat-interface.tsx` 第16行是否为 `useState(false)`

---

## ✅ 验证清单

测试完成后，请确认以下所有项：

- [ ] 工具调用卡片默认是折叠状态
- [ ] 工具调用完成后可以手动展开查看
- [ ] 没有重复的thinking状态显示
- [ ] 切换会话时，正在进行的请求被中断
- [ ] AI响应只出现在对应的会话中
- [ ] 会话历史记录完整保留
- [ ] 多个会话之间完全隔离
- [ ] 浏览器控制台有正确的日志输出

---

## 📞 问题反馈

如果测试中发现任何问题，请提供：
1. **问题描述**：具体是什么问题
2. **复现步骤**：如何触发这个问题
3. **浏览器控制台日志**：完整的错误或警告信息
4. **预期行为**：你期望看到什么结果
5. **实际行为**：实际看到了什么结果

---

**测试准备完毕** ✅  
**服务运行状态**: 正常 ✅  
**代码更新状态**: 完成 ✅  

**请开始测试！** 🚀
